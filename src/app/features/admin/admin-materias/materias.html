<div class="materias-container">
    <!-- Sistema de Pestañas -->
    <div class="tabs-container">
        <button 
            class="tab-button" 
            [class.active]="pestanaActiva === 'materias'"
            (click)="cambiarPestana('materias')">
            <i class="fas fa-book me-2"></i>Materias
        </button>
        <button 
            class="tab-button" 
            [class.active]="pestanaActiva === 'areas'"
            (click)="cambiarPestana('areas')">
            <i class="fas fa-layer-group me-2"></i>Áreas de Conocimiento
        </button>
    </div>

    <!-- Alerts Globales -->
    @if (alertSuccess) {
        <div class="alert alert-success mb-3">
            <i class="fas fa-check-circle me-2"></i>{{ alertSuccess }}
        </div>
    }
    
    @if (alertError) {
        <div class="alert alert-danger mb-3">
            <i class="fas fa-exclamation-circle me-2"></i>{{ alertError }}
        </div>
    }

    @if (showEliminar) {
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar esta materia?</p>
                    <p class="text-muted">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" (click)="eliminar()">
                        <i class="fas fa-trash me-1"></i>Eliminar
                    </button>
                    <button class="btn btn-secondary" (click)="cancelarEliminar()">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- ============== PESTAÑA DE MATERIAS ============== -->
    @if (pestanaActiva === 'materias' && !mostrarFormulario) {
        <div class="panel-principal">
            <div class="panel-header">
                <div class="header-content">
                    <h2 class="panel-title">
                        <i class="fas fa-book me-2"></i>Gestión de Materias
                    </h2>
                    <p class="panel-subtitle">Administra las materias del sistema</p>
                </div>
                <button class="btn btn-primary btn-add" (click)="abrirFormularioNuevo()">
                    <i class="fas fa-plus me-2"></i>Nueva Materia
                </button>
            </div>

            @if (cargandoDatos) {
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Cargando materias...</p>
                </div>
            }

            @if (sinMaterias) {
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <h3>Aún no hay materias registradas</h3>
                    <p>Comienza agregando la primera materia al sistema.</p>
                    <button class="btn btn-primary" (click)="abrirFormularioNuevo()">
                        <i class="fas fa-plus me-2"></i>Agregar Primera Materia
                    </button>
                </div>
            }

            @if (!cargandoDatos && !sinMaterias) {
                <div class="materias-grid">
                    @for (materia of materias; track materia.id) {
                        <div class="materia-card">
                            <div class="card-header">
                                <h4 class="materia-nombre">{{ materia.nombre }}</h4>
                                <div class="materia-meta">
                                    <span class="materia-codigo">{{ materia.codigo }}</span>
                                    @if (materia.area) {
                                        <span class="materia-area badge-area" [style.background]="getColorArea(materia.area)">{{ getNombreArea(materia.area) }}</span>
                                    }
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="docente-info-card">
                                    @if (materia.docenteNombre) {
                                        <div class="docente-asignado">
                                            <i class="fas fa-user-tie me-2"></i>
                                            <div class="docente-details">
                                                <strong>{{ materia.docenteNombre }}</strong>
                                                <small>Legajo: {{ materia.docenteLegajo }} | DNI: {{ materia.docenteDni || 'N/A' }}</small>
                                            </div>
                                        </div>
                                    } @else {
                                        <div class="sin-docente">
                                            <i class="fas fa-user-slash me-2"></i>
                                            <span class="text-muted">Sin docente asignado</span>
                                        </div>
                                    }
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline-primary" 
                                        (click)="editar(materia)"
                                        title="Editar materia">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        (click)="confirmarEliminar(materia.id)"
                                        title="Eliminar materia">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    } @empty {
                        <div class="empty-message">No hay materias disponibles</div>
                    }
                </div>
            }
        </div>
    }

    @if (pestanaActiva === 'materias' && mostrarFormulario) {
        <div class="panel-formulario">
            <div class="panel-header">
                <div class="header-content">
                    <h2 class="panel-title">
                        <i class="fas fa-{{ modoEdicion ? 'edit' : 'plus' }} me-2"></i>
                        {{ modoEdicion ? 'Editar Materia' : 'Nueva Materia' }}
                    </h2>
                    <p class="panel-subtitle">
                        {{ modoEdicion ? 'Modifica los datos de la materia' : 'Completa los datos de la nueva materia' }}
                    </p>
                </div>
                <button class="btn btn-outline-secondary" (click)="cerrarFormulario()">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
            </div>

            <div class="formulario-content">
                <form (ngSubmit)="guardar()" #materiaForm="ngForm">
                    <div class="form-section">
                        
                        <div class="form-group">
                            <label class="form-label">Nombre de la materia *</label>
                            <input type="text" 
                                class="form-control" 
                                [(ngModel)]="formData.nombre" 
                                name="nombre"
                                placeholder="Ej: Matemática, Historia, Lengua..." 
                                required
                                #nombreInput="ngModel">
                            @if (nombreInput && nombreInput.invalid && nombreInput.touched) {
                                <div class="invalid-feedback">
                                    El nombre de la materia es obligatorio
                                </div>
                            }
                        </div>

                        <div class="form-group">
                            <label class="form-label">Código de la materia *</label>
                            <input type="text" 
                                class="form-control" 
                                [(ngModel)]="formData.codigo" 
                                name="codigo"
                                placeholder="Ej: MAT101, HIS201, LEN301..." 
                                required
                                #codigoInput="ngModel">
                            @if (codigoInput && codigoInput.invalid && codigoInput.touched) {
                                <div class="invalid-feedback">
                                    El código de la materia es obligatorio
                                </div>
                            }
                        </div>

                        <div class="form-group">
                            <label class="form-label">Área de Conocimiento *</label>
                            <select 
                                class="form-control" 
                                [(ngModel)]="formData.area" 
                                name="area"
                                required
                                #areaInput="ngModel">
                                <option value="">Seleccione un área...</option>
                                @for (area of areasDisponibles; track area.valor) {
                                    <option [value]="area.valor">{{ area.nombre }}</option>
                                }
                            </select>
                            @if (areaInput && areaInput.invalid && areaInput.touched) {
                                <div class="invalid-feedback">
                                    El área de conocimiento es obligatoria
                                </div>
                            }
                        </div>
                    </div>

                    <div class="form-section">
                        <h5 class="section-title">Asignación de Docente</h5>
                        <p class="section-description">
                            Puedes asignar un docente ahora o dejarlo para más tarde.
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">Docente (Opcional)</label>
                            @if (docenteSeleccionado) {
                                <div class="docente-selected">
                                    <div class="docente-info">
                                        <i class="fas fa-user-tie"></i>
                                        <div>
                                            <strong>{{ docenteSeleccionado.name }}</strong>
                                            <small>Legajo: {{ docenteSeleccionado.legajo }} | DNI: {{ docenteSeleccionado.dni || 'N/A' }}</small>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger" (click)="quitarDocente()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            } @else {
                                <div class="docente-search">
                                    <input type="text" 
                                        class="form-control" 
                                        [(ngModel)]="busquedaDocente" 
                                        (ngModelChange)="filtrarDocentes()"
                                        name="busquedaDocente"
                                        placeholder="Buscar por nombre, legajo o DNI..."
                                        autocomplete="off">
                                    
                                    @if (mostrarListaDocentes && docentesFiltrados.length > 0) {
                                        <div class="docentes-list">
                                            @for (docente of docentesFiltrados; track docente.id_usuario) {
                                                <div class="docente-item" (click)="seleccionarDocente(docente)">
                                                    <i class="fas fa-user-circle"></i>
                                                    <div class="docente-data">
                                                        <strong>{{ docente.name }}</strong>
                                                        <small>Legajo: {{ docente.legajo }} | DNI: {{ docente.dni || 'N/A' }}</small>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    
                                    @if (mostrarListaDocentes && busquedaDocente && docentesFiltrados.length === 0) {
                                        <div class="no-results">
                                            <i class="fas fa-search"></i>
                                            <p>No se encontraron docentes</p>
                                        </div>
                                    }
                                </div>
                            }
                            
                            <small class="form-text text-muted">
                                Busca y selecciona un docente para asignar a esta materia.
                            </small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" 
                                class="btn btn-primary"
                                (click)="guardarManual()">
                            <i class="fas fa-save me-2"></i>
                            {{ modoEdicion ? 'Actualizar Materia' : 'Guardar Materia' }}
                        </button>
                        <!-- Debug: Mostrar estado del form -->
                        <small class="text-muted d-block mt-2">
                          Form valid: {{ materiaForm.valid }} | Form invalid: {{ materiaForm.invalid }}
                        </small>
                        <button type="button" 
                                class="btn btn-secondary" 
                                (click)="cerrarFormulario()">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    }

    <!-- ============== PESTAÑA DE ÁREAS ============== -->
    @if (pestanaActiva === 'areas') {
        <!-- Modal eliminar área -->
        @if (showEliminarArea) {
            <div class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar Eliminación</h5>
                    </div>
                    <div class="modal-body">
                        <p>¿Está seguro que desea eliminar esta área?</p>
                        <p class="text-muted">Esta acción no se puede deshacer.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" (click)="eliminarArea()">
                            <i class="fas fa-trash me-1"></i>Eliminar
                        </button>
                        <button class="btn btn-secondary" (click)="cancelarEliminarArea()">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                    </div>
                </div>
            </div>
        }

        @if (!mostrarFormularioArea) {
            <div class="panel-principal">
                <div class="panel-header">
                    <div class="header-content">
                        <h2 class="panel-title">
                            <i class="fas fa-layer-group me-2"></i>Áreas de Conocimiento
                        </h2>
                        <p class="panel-subtitle">Gestiona las áreas y asigna materias</p>
                    </div>
                    <button class="btn btn-primary btn-add" (click)="abrirFormularioNuevaArea()">
                        <i class="fas fa-plus me-2"></i>Nueva Área
                    </button>
                </div>

                <div class="areas-grid">
                    @for (area of areasDisponibles; track area.valor) {
                        <div class="area-card" [style.border-left]="'4px solid ' + area.color">
                            <div class="area-header">
                                <div class="area-badge" [style.background]="area.color">
                                    {{ area.valor }}
                                </div>
                                <div class="area-actions">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            (click)="abrirFormularioEditarArea(area)"
                                            title="Editar área">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            (click)="confirmarEliminarArea(area.valor)"
                                            title="Eliminar área">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="area-body">
                                <h4 class="area-nombre">{{ area.nombre }}</h4>
                                @if (area.descripcion) {
                                    <p class="area-descripcion">{{ area.descripcion }}</p>
                                }
                                <div class="area-stats">
                                    <span class="stat-badge">
                                        <i class="fas fa-book me-1"></i>
                                        {{ getMateriasDeArea(area.valor).length }} materias
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Lista de materias del área -->
                            @if (getMateriasDeArea(area.valor).length > 0) {
                                <div class="area-materias-list">
                                    <h6 class="list-title">Materias asignadas:</h6>
                                    @for (materia of getMateriasDeArea(area.valor); track materia.id) {
                                        <div class="materia-item-small">
                                            <span class="materia-codigo-small">{{ materia.codigo }}</span>
                                            <span class="materia-nombre-small">{{ materia.nombre }}</span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Formulario de áreas -->
        @if (mostrarFormularioArea) {
            <div class="panel-formulario">
                <div class="panel-header">
                    <div class="header-content">
                        <h2 class="panel-title">
                            <i class="fas fa-{{ modoEdicionArea ? 'edit' : 'plus' }} me-2"></i>
                            {{ modoEdicionArea ? 'Editar Área' : 'Nueva Área' }}
                        </h2>
                        <p class="panel-subtitle">
                            {{ modoEdicionArea ? 'Modifica los datos del área' : 'Completa los datos de la nueva área' }}
                        </p>
                    </div>
                    <button class="btn btn-outline-secondary" (click)="cerrarFormularioArea()">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                </div>

                <div class="formulario-content">
                    <form (ngSubmit)="guardarArea()" #areaForm="ngForm">
                        <div class="form-section">
                            <div class="form-group">
                                <label class="form-label">Código del Área *</label>
                                <input type="text" 
                                    class="form-control" 
                                    [(ngModel)]="formDataArea.valor" 
                                    name="valor"
                                    placeholder="Ej: EXACTAS, SOCIALES..." 
                                    required
                                    [disabled]="modoEdicionArea"
                                    #valorInput="ngModel">
                                <small class="form-text text-muted">
                                    Se convertirá automáticamente a mayúsculas sin espacios
                                </small>
                                @if (valorInput && valorInput.invalid && valorInput.touched) {
                                    <div class="invalid-feedback">
                                        El código del área es obligatorio
                                    </div>
                                }
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nombre del Área *</label>
                                <input type="text" 
                                    class="form-control" 
                                    [(ngModel)]="formDataArea.nombre" 
                                    name="nombre"
                                    placeholder="Ej: Ciencias Exactas, Humanidades..." 
                                    required
                                    #nombreAreaInput="ngModel">
                                @if (nombreAreaInput && nombreAreaInput.invalid && nombreAreaInput.touched) {
                                    <div class="invalid-feedback">
                                        El nombre del área es obligatorio
                                    </div>
                                }
                            </div>

                            <div class="form-group">
                                <label class="form-label">Descripción</label>
                                <textarea 
                                    class="form-control" 
                                    [(ngModel)]="formDataArea.descripcion" 
                                    name="descripcion"
                                    rows="3"
                                    placeholder="Descripción opcional del área..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Color del Área</label>
                                <div class="color-picker-container">
                                    <input type="color" 
                                        class="form-control color-input" 
                                        [(ngModel)]="formDataArea.color" 
                                        name="color">
                                    <span class="color-preview" [style.background]="formDataArea.color"></span>
                                    <span class="color-value">{{ formDataArea.color }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" 
                                    class="btn btn-primary"
                                    [disabled]="areaForm.invalid">
                                <i class="fas fa-save me-2"></i>
                                {{ modoEdicionArea ? 'Actualizar Área' : 'Guardar Área' }}
                            </button>
                            <button type="button" 
                                    class="btn btn-secondary" 
                                    (click)="cerrarFormularioArea()">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }
    }
</div>