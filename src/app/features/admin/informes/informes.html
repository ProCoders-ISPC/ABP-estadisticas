<div class="informes-container">
  <!-- Selector de tipo de informe -->
  <div class="form-section">
    <div class="form-group">
      <label for="tipoInforme">Seleccionar Tipo de Informe</label>
      <select 
        id="tipoInforme" 
        class="form-control" 
        [(ngModel)]="tipoInforme" 
        (change)="generarInforme()"
      >
        <option value="distribucion-areas">Distribución de Docentes por Área</option>
        <option value="carga-academica">Carga Académica por Docente</option>
        <option value="distribucion-materias">Distribución de Materias</option>
        <option value="estudiantes-asistencia">Estudiantes y Asistencia</option>
      </select>
    </div>
  </div>

  @if (cargandoDatos) {
    <div class="loading-indicator">
      <div class="spinner"></div>
      <p>Generando análisis estadístico...</p>
    </div>
  }

  @if (error) {
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i>
      {{ error }}
      <button class="btn btn-sm btn-outline-primary ml-2" (click)="generarInforme()">
        Reintentar
      </button>
    </div>
  }

  @if (informeGenerado && !cargandoDatos && !error) {
    <div class="informe-results">
      
      @if (tipoInforme === 'distribucion-areas' && datosGraficoAreas) {
        <div class="analysis-section">
          <h3>Distribución de Docentes por Área</h3>
          
         
          <div class="chart-container">
            <app-grafico-barras [datos]="datosGraficoAreas"></app-grafico-barras>
          </div>
          
          <div class="data-table">
            <h4>Datos Detallados</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>Área</th>
                  <th>Cantidad</th>
                  <th>Porcentaje</th>
                </tr>
              </thead>
              <tbody>
                @for (item of distribucionAreas; track item.area) {
                  <tr>
                    <td>{{ item.area }}</td>
                    <td>{{ item.cantidad }}</td>
                    <td>{{ item.porcentaje }}%</td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="3">No hay datos disponibles</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          
          <div class="interpretation">
            <h4>Interpretación del Análisis</h4>
            <p>{{ getInterpretacionDistribucion() }}</p>
          </div>
        </div>
      }

      @if (tipoInforme === 'carga-academica' && datosGraficoCarga) {
        <div class="analysis-section">
          <h3>Análisis de Carga Académica</h3>
          
          @if (estadisticasCarga) {
            <div class="statistics-summary">
              <div class="stat-card">
                <h4>Promedio</h4>
                <span class="stat-value">{{ getPromedioFormateado() }}</span>
                <small>materias por docente</small>
              </div>
              <div class="stat-card">
                <h4>Mediana</h4>
                <span class="stat-value">{{ estadisticasCarga.mediana }}</span>
                <small>materias por docente</small>
              </div>
              <div class="stat-card">
                <h4>Máximo</h4>
                <span class="stat-value">{{ estadisticasCarga.maximo }}</span>
                <small>materias asignadas</small>
              </div>
              <div class="stat-card">
                <h4>Desv. Estándar</h4>
                <span class="stat-value">{{ getDesviacionFormateada() }}</span>
                <small>variabilidad</small>
              </div>
            </div>
          }
          
          <div class="chart-container">
            <app-grafico-barras [datos]="datosGraficoCarga"></app-grafico-barras>
          </div>
          
          <div class="interpretation">
            <h4>Interpretación del Análisis</h4>
            <p>{{ getInterpretacionCarga() }}</p>
          </div>
        </div>
      }

      
      @if (tipoInforme === 'distribucion-materias' && datosGraficoMaterias) {
        <div class="analysis-section">
          <h3>Distribución de Materias por Área de Conocimiento</h3>
          
          @if (estadisticasMaterias) {
            <div class="statistics-summary">
              <div class="stat-card">
                <h4>Total Materias</h4>
                <span class="stat-value">{{ estadisticasMaterias.totalMaterias }}</span>
                <small>en el sistema</small>
              </div>
              <div class="stat-card success">
                <h4>Asignadas</h4>
                <span class="stat-value">{{ estadisticasMaterias.totalAsignadas }}</span>
                <small>{{ getPorcentajeAsignacionFormateado() }}% del total</small>
              </div>
              <div class="stat-card warning">
                <h4>Sin Asignar</h4>
                <span class="stat-value">{{ estadisticasMaterias.totalSinAsignar }}</span>
                <small>{{ (100 - estadisticasMaterias.porcentajeAsignacion).toFixed(1) }}% del total</small>
              </div>
              <div class="stat-card info">
                <h4>% Asignación</h4>
                <span class="stat-value">{{ getPorcentajeAsignacionFormateado() }}%</span>
                <small>cobertura total</small>
              </div>
            </div>
          }
          
          
          <div class="chart-container">
            <app-grafico-barras [datos]="datosGraficoMaterias"></app-grafico-barras>
          </div>

          
          @if (datosGraficoAsignacion) {
            <div class="chart-container">
              <div class="chart-header">
                <h4>Comparativo: Materias Asignadas vs Sin Asignar</h4>
              </div>
              <div class="comparison-chart">
                @for (area of distribucionMaterias; track area.area) {
                  <div class="area-comparison">
                    <div class="area-name">{{ area.area }}</div>
                    <div class="bars-container">
                      <div class="bar-group">
                        <div class="bar assigned" 
                             [style.height.px]="(area.materiasAsignadas / getMaxMaterias()) * 200"
                             [title]="'Asignadas: ' + area.materiasAsignadas">
                          <span class="bar-value">{{ area.materiasAsignadas }}</span>
                        </div>
                        <label>Asignadas</label>
                      </div>
                      <div class="bar-group">
                        <div class="bar unassigned" 
                             [style.height.px]="(area.materiasSinAsignar / getMaxMaterias()) * 200"
                             [title]="'Sin asignar: ' + area.materiasSinAsignar">
                          <span class="bar-value">{{ area.materiasSinAsignar }}</span>
                        </div>
                        <label>Sin Asignar</label>
                      </div>
                    </div>
                    <div class="percentage-info">
                      <span class="assigned-percent">{{ area.porcentajeAsignadas.toFixed(1) }}% asignadas</span>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
          
         
          <div class="data-table">
            <h4>Datos Detallados por Área</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>Área de Conocimiento</th>
                  <th>Total Materias</th>
                  <th>Asignadas</th>
                  <th>Sin Asignar</th>
                  <th>% Asignación</th>
                </tr>
              </thead>
              <tbody>
                @for (item of distribucionMaterias; track item.area) {
                  <tr>
                    <td>{{ item.area }}</td>
                    <td>{{ item.totalMaterias }}</td>
                    <td class="text-success">{{ item.materiasAsignadas }}</td>
                    <td class="text-warning">{{ item.materiasSinAsignar }}</td>
                    <td>
                      <div class="progress-bar-container">
                        <div class="progress-bar" [style.width.%]="item.porcentajeAsignadas"></div>
                        <span class="progress-text">{{ item.porcentajeAsignadas.toFixed(1) }}%</span>
                      </div>
                    </td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="5">No hay datos disponibles</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          
          <div class="interpretation">
            <h4>Interpretación del Análisis</h4>
            <p>{{ getInterpretacionMaterias() }}</p>
            
            @if (estadisticasMaterias && estadisticasMaterias.totalSinAsignar > 0) {
              <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Atención:</strong> Hay {{ estadisticasMaterias.totalSinAsignar }} materias sin asignar que requieren atención.
                Se recomienda revisar la disponibilidad de docentes en las áreas con mayor déficit.
              </div>
            }
          </div>
        </div>
      }

      <!-- NUEVO: INFORME DE ESTUDIANTES Y ASISTENCIA -->
      @if (tipoInforme === 'estudiantes-asistencia' && estadisticasEstudiantes) {
        <div class="analysis-section">
          <h3>Análisis de Estudiantes y Asistencia</h3>
          
          <!-- Estadísticas generales -->
          <div class="statistics-summary">
            <div class="stat-card">
              <h4>Total Estudiantes</h4>
              <span class="stat-value">{{ estadisticasEstudiantes.totalEstudiantes }}</span>
              <small>en el sistema</small>
            </div>
            <div class="stat-card success">
              <h4>Activos</h4>
              <span class="stat-value">{{ estadisticasEstudiantes.estudiantesActivos }}</span>
              <small>{{ getPorcentajeActivosFormateado() }}% del total</small>
            </div>
            <div class="stat-card info">
              <h4>Asistencia Promedio</h4>
              <span class="stat-value">{{ getPromedioAsistenciaFormateado() }}%</span>
              <small>general del sistema</small>
            </div>
            <div class="stat-card warning">
              <h4>Inactivos</h4>
              <span class="stat-value">{{ estadisticasEstudiantes.estudiantesInactivos }}</span>
              <small>sin actividad reciente</small>
            </div>
          </div>
          
          <!-- Gráfico de torta: Distribución por área -->
          @if (datosGraficoPieEstudiantes) {
            <div class="chart-container">
              <app-grafico-pie [datos]="datosGraficoPieEstudiantes" [donutStyle]="true"></app-grafico-pie>
            </div>
          }
          
          <!-- Gráfico de asistencia semanal -->
          @if (datosGraficoAsistenciaSemanal) {
            <div class="chart-container">
              <app-grafico-barras [datos]="datosGraficoAsistenciaSemanal"></app-grafico-barras>
            </div>
          }

          <!-- Tabla de asistencia por semana -->
          @if (asistenciaSemanal.length > 0) {
            <div class="data-table">
              <h4>Detalle de Asistencia Semanal</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>Semana</th>
                    <th>Presentes</th>
                    <th>Ausentes</th>
                    <th>Tardanzas</th>
                    <th>% Asistencia</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of asistenciaSemanal; track item.semana) {
                    <tr>
                      <td>{{ item.semana }}</td>
                      <td class="text-success">{{ item.presentes }}</td>
                      <td class="text-danger">{{ item.ausentes }}</td>
                      <td class="text-warning">{{ item.tardanzas }}</td>
                      <td>
                        <div class="progress-bar-container">
                          <div class="progress-bar" [style.width.%]="item.porcentaje"></div>
                          <span class="progress-text">{{ item.porcentaje.toFixed(1) }}%</span>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }

          <!-- Tabla de estudiantes con asistencia -->
          @if (estudiantesConAsistencia.length > 0) {
            <div class="data-table">
              <h4>Ranking de Asistencia por Estudiante (Top 20)</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>Posición</th>
                    <th>Estudiante</th>
                    <th>Legajo</th>
                    <th>Clases</th>
                    <th>Presentes</th>
                    <th>Ausentes</th>
                    <th>Tardanzas</th>
                    <th>% Asistencia</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  @for (estudiante of estudiantesConAsistencia.slice(0, 20); track estudiante.id; let i = $index) {
                    <tr>
                      <td>
                        <span class="ranking-badge" [class.top-3]="i < 3">{{ i + 1 }}</span>
                      </td>
                      <td>{{ estudiante.nombre }}</td>
                      <td>{{ estudiante.legajo }}</td>
                      <td>{{ estudiante.totalClases }}</td>
                      <td class="text-success">{{ estudiante.presentes }}</td>
                      <td class="text-danger">{{ estudiante.ausentes }}</td>
                      <td class="text-warning">{{ estudiante.tardanzas }}</td>
                      <td>
                        <div class="progress-bar-container">
                          <div 
                            class="progress-bar" 
                            [style.width.%]="estudiante.porcentajeAsistencia"
                            [style.background]="getColorAsistencia(estudiante.porcentajeAsistencia)"
                          ></div>
                          <span class="progress-text">{{ estudiante.porcentajeAsistencia.toFixed(1) }}%</span>
                        </div>
                      </td>
                      <td>
                        <span 
                          class="badge-asistencia"
                          [style.background-color]="getColorAsistencia(estudiante.porcentajeAsistencia)"
                        >
                          {{ getEstadoAsistencia(estudiante.porcentajeAsistencia) }}
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
          
          <!-- Interpretación del análisis -->
          <div class="interpretation">
            <h4>Interpretación del Análisis</h4>
            <p>
              Del total de {{ estadisticasEstudiantes.totalEstudiantes }} estudiantes, 
              {{ estadisticasEstudiantes.estudiantesActivos }} están activos 
              ({{ getPorcentajeActivosFormateado() }}% del total).
            </p>
            <p>
              El promedio general de asistencia es del {{ getPromedioAsistenciaFormateado() }}%, 
              @if (estadisticasEstudiantes.promedioAsistencia >= 80) {
                lo cual indica un excelente nivel de compromiso estudiantil.
              } @else if (estadisticasEstudiantes.promedioAsistencia >= 70) {
                lo cual es un nivel aceptable pero mejorable.
              } @else {
                lo cual requiere atención y estrategias de mejora.
              }
            </p>
            @if (estudiantesConAsistencia.length > 0) {
              <p>
                Se han identificado {{ getEstudiantesCriticos() }} 
                estudiantes con asistencia crítica (menor al 60%) que requieren seguimiento especial.
              </p>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
